{
  "version": 3,
  "sources": ["../src/tools.js", "../src/index.js"],
  "sourcesContent": ["export const numOrZero = num=>{ \r\n    const n = Number(num);\r\n    return isNaN(n) ? 0 : Math.max(0, n);\r\n}\r\n\r\nexport const toArray = any=>{\r\n    if (any == null) { return []; }\r\n    if (Array.isArray(any)) { return any; }\r\n    return [ any ];\r\n}", "import { numOrZero, toArray } from \"./tools\";\n\nconst _pass = [\"all\", \"first\", \"last\"];\n\nexport const fakePromise = ()=>{\n    const prom = {};\n    prom.result = new Promise((res, rej)=>{\n        prom.resolve = res;\n        prom.reject = rej;\n    });\n    return prom;\n}\n\nexport class Queue extends Function {\n\n    constructor(processTasks, opt={}) {\n        super();\n\n        opt = typeof opt === \"object\" ? opt : {};\n\n        if (typeof processTasks !== \"function\") { throw Error(\"Queue(...) expect first argument to be function\"); }\n\n        const onInit = opt.onInit;\n        if (onInit && typeof onInit !== \"function\") { throw Error(\"Queue(...) expect opt.onInit to be function\"); }\n\n        const pass = opt.pass != null ? opt.pass : \"all\";\n        if (!_pass.includes(pass)) { throw Error(`Queue(...) expect opt.pass to be one of: '${_pass.join(\"|\")}'`); }\n        \n        const args = toArray(opt.args);\n        const minSize = numOrZero(opt.minSize);\n        const maxSize = numOrZero(opt.maxSize);\n        const hardMs = numOrZero(opt.hardMs);\n        const softMs = numOrZero(opt.softMs);\n        const softMsActive = !!softMs;\n        const hardMsActive = hardMs > softMs;\n        \n        \n        let pcq, intA, intB, startAt, prom, tasks = [];\n\n        if (pass === \"all\") { pcq = async q=>processTasks(...args, q); }\n        else if (pass === \"first\") { pcq = async q=>processTasks(...args, ...q[0]); }\n        else if (pass === \"last\") { pcq = async q=>processTasks(...args, ...q[q.length-1]); }\n\n        const init = _=>{\n            startAt = Date.now();\n            prom = fakePromise();\n            if (onInit) { onInit(); }\n            if (hardMsActive) { intB = setTimeout(execute, hardMs); }\n        }\n\n        const flush = _=>{\n            clearTimeout(intA);\n            clearTimeout(intB);\n            tasks = [];\n            startAt = undefined;\n        }\n\n        const execute = async _=>{\n            const q = tasks;\n            flush();\n            if (q.length < minSize) { return prom?.resolve(); }\n            return pcq(q).then(prom.resolve).catch(prom.reject);\n        };\n\n        const attach = async (...args)=>{\n            clearTimeout(intA);\n            tasks.push(args);\n\n            if (tasks.length === 1) {init();}\n            if (maxSize && tasks.length >= maxSize) { execute(); }\n            else if (softMsActive) { intA = setTimeout(execute, softMs); }\n\n            if (opt.returnResult) { return prom.result; }\n        }\n\n        const self = Object.setPrototypeOf(attach, new.target.prototype);\n\n        Object.defineProperties(self, {\n            isPending:{ enumerable:true, get:_=>!!startAt },\n            size:{ enumerable:true, get:_=>tasks.length },\n            startAt:{ enumerable:true, get:_=>startAt },\n            softEndAt:{ enumerable:true, get:_=>(!startAt || !softMsActive) ? undefined : (startAt + softMs) },\n            hardEndAt:{ enumerable:true, get:_=>(!startAt || !hardMsActive) ? undefined : (startAt + hardMs) },\n            execute:{ value:execute },\n            flush:{ value:flush }\n        });\n\n        return self;\n    }\n}\n\nexport const createQueue = (processTasks, opt={})=>new Queue(processTasks, opt);\n\nexport default createQueue;\n"],
  "mappings": "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",
  "names": ["args"]
}
